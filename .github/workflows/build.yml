name: Build

on: push

env:
  FORCE_COLOR: true
  netBuildPlatform: "Any CPU"
  netBuildConfiguration: "Release"

jobs:
  build:
    runs-on: ${{ matrix.imageName }}
    strategy:
      matrix:
        imageName: [windows-latest, macos-10.15, ubuntu-22.04]
        include:
          - imageName: windows-latest
            jobArchName: "Windows"
            agentArch: "windows"
            artifactPrefix: "windows."
            artifactSuffix: ""
            netbuilder: "core"
            lualibs: "prebuilt"
            loveURL: "https://github.com/love2d/love/releases/download/11.3/love-11.3-win32.zip"
            loveZIP: "love.zip"
            loveTAR: ""
            loveBinaryDirectory: ""
            loveResourcesDirectory: ""
            loveBinary: "love.exe"
          - imageName: macos-10.15
            jobArchName: "macOS"
            agentArch: "macOS"
            artifactPrefix: "macos."
            artifactSuffix: ""
            netbuilder: "mono"
            monokickURL: "https://github.com/flibitijibibo/MonoKickstart.git"
            lualibs: "luarocks"
            luarocksPreArgs: "--lua-dir=/usr/local/opt/lua@5.1"
            luarocksArgs: 'LUA_LIBDIR="/usr/local/opt/lua@5.1/lib"'
            loveURL: "https://github.com/love2d/love/releases/download/11.3/love-11.3-macos.zip"
            loveZIP: "love.zip"
            loveTAR: ""
            loveBinaryDirectory: "love.app/Contents/MacOS/"
            loveResourcesDirectory: "love.app/Contents/Resources/"
            launcher: ""
          - imageName: ubuntu-22.04
            jobArchName: "linux"
            agentArch: "linux"
            artifactPrefix: "linux."
            artifactSuffix: ""
            netbuilder: "mono"
            monokickURL: "https://github.com/flibitijibibo/MonoKickstart.git"
            lualibs: "luarocks"
            luarocksArgs: 'LUA_LIBDIR="/usr/local/opt/lua/lib"'
            loveURL: "https://github.com/love2d/love/releases/download/11.3/love-11.3-linux-x86_64.tar.gz"
            loveZIP: ""
            loveTAR: "love.tar.gz"
            loveBinaryDirectory: ""
            loveResourcesDirectory: ""
            launcher: ""

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: "recursive"
          fetch-depth: 3

      # Prepare dependencies {{{
      # Use brew on macOS.
      - name: "Setup: macOS: brew: install lua lua@5.1 luarocks"
        if: ${{ success() && matrix.agentArch == 'macOS' }}
        run: |
          export HOMEBREW_NO_INSTALL_CLEANUP=1
          brew install lua lua@5.1 luarocks

      # Use apt on Ubuntu.
      - name: "Setup: Linux: apt: install luarocks and deps"
        if: ${{ success() && matrix.agentArch == 'linux' }}
        run: |
          sudo apt -y update && sudo apt -y install luarocks libgtk-3-dev

      # Cross platform setup.
      - name: "Setup: luarocks: config"
        if: ${{ success() && matrix.lualibs == 'luarocks' }}
        run: |
          git config --global url."https://github.com/".insteadOf git://github.com/
          luarocks config lua_version 5.1
          luarocks
